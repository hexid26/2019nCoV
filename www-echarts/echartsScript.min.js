let geoJson="";let global_date_list=[];let global_date_list_end=0;let global_json=[];let global_china_dataset=[];let load_done=false;read_china_json=$.ajax({async:true,global:true,url:"china.json",beforeSend:function(){},success:function(data){geoJson=data}});read_global_json=$.ajax({async:true,global:true,url:"history-areas-all.json",beforeSend:function(){},success:function(data){global_china_dataset[0]=["状态"].concat(data[2]["date"]);global_china_dataset[1]=["确诊"].concat(data[2]["confirmedCount"]);global_china_dataset[2]=["疑似"].concat(data[2]["suspectedCount"]);global_china_dataset[3]=["治愈"].concat(data[2]["curedCount"]);global_china_dataset[4]=["死亡"].concat(data[2]["deadCount"]);for(let index=1;index<global_china_dataset[0].length;index++){global_china_dataset[0][index]=global_china_dataset[0][index].slice(5)}global_date_list=data[3].reverse();global_date_list_end=global_date_list.length-1;global_json=data.slice(4);for(let index=0;index<global_date_list.length;index++){global_date_list[index]=global_date_list[index].slice(5)}load_done=true}});function sleep(ms){return new Promise(resolve=>setTimeout(resolve,ms))}let chinaChart;function set_chinaChart_dom(id){chinaChart=echarts.init(document.getElementById(id));chinaChart.showLoading();chinaChart.on("click",e=>{chinaMapClick(e);event.stopPropagation()})}chinaChart=echarts.init(document.getElementById("chinaChart"));let option_chinaChart="";let province_dataset=new Array();function init_chinaChart(){$.when(read_china_json).done(function(){echarts.registerMap("china",geoJson);$.when(read_global_json).done(async function(){while(load_done==false){await sleep(30)}set_option_chinaChart();for(let index=0;index<global_json.length;index++){province_dataset[index]={name:global_json[index]["provinceShortName"],value:global_json[index]["confirmedCount"][global_date_list_end]}}init_provincePie("中国");init_populationChart("中国","中国");option_chinaChart["series"][0]["data"]=province_dataset;chinaChart.hideLoading();chinaChart.setOption(option_chinaChart)})})}function set_option_chinaChart(){option_chinaChart={roam:isMobile?true:false,layoutCenter:["50%","50%"],layoutSize:"120%",title:{text:isMobile?"确诊和疑似共 "+String(global_china_dataset[1][global_china_dataset[1].length-1]+global_china_dataset[2][global_china_dataset[2].length-1])+" 人":"2019-nCoV 各省市数据\n\n确诊和疑似共 "+String(global_china_dataset[1][global_china_dataset[1].length-1]+global_china_dataset[2][global_china_dataset[2].length-1])+" 人\n\n随处点点吧",top:"1%",left:"center",textStyle:{color:"#aa2222"}},tooltip:{trigger:"item",formatter:"{b}<br/>确诊 {c} 人"},toolbox:{show:true,orient:"vertical",left:"right",top:"bottom",itemSize:isMobile?20:15,feature:{saveAsImage:{type:"jpeg",pixelRatio:4}}},visualMap:{type:"piecewise",pieces:[{gt:500,label:">500",color:"#C00000"},{gt:200,lt:500,label:"201~500",color:"#E80000"},{gt:100,lt:200,label:"101~200",color:"#FF8080"},{gt:0,lt:100,label:"1~100",color:"#FFBBBB"},{value:0,label:"无",color:"#FFFFFF"}],align:"auto",itemHeight:isMobile?10:20,itemWidth:isMobile?10:20,itemGap:isMobile?3:5,itemSymbol:"roundRect",align:isMobile?"right":"left",top:isMobile?"45%":"middle",left:isMobile?"right":"5%",borderColor:"#FF0000",borderWidth:isMobile?0:1,selectedMode:false,textStyle:{fontSize:14}},series:[{name:"全国各省市感染人数",type:"map",mapType:"china",label:{show:true,fontSize:isMobile?10:12}}],graphic:{elements:[{type:"text",invisible:isMobile?false:true,left:"5%",bottom:"2%",slient:true,style:{text:"点击图中『省份』或『空白』联动下图",font:isMobile?'12px "cursive", sans-serif':'14px "cursive", sans-serif',fill:"#8888FF"}}]}}}function chinaMapClick(params){if(params.value===null){return}let provinceName=params.data.name;if(provinceName===""){provinceName="中国"}init_provincePie(provinceName);init_populationChart(provinceName,provinceName)}if(isMobile){tap(chinaChart_bg,function(e){init_provincePie("中国");init_populationChart("中国","中国")})}else{chinaChart_bg.addEventListener("click",function(e){if(e){init_provincePie("中国");init_populationChart("中国","中国")}},false)}function tap(el,callBack){let startTime=0;let maxTime=250;let[startX,startY,endX,endY]=[0,0,0,0];el.addEventListener("touchstart",function(e){startTime=Date.now();startX=e.touches[0].clientX;startY=e.touches[0].clientY});el.addEventListener("touchmove",function(e){endX=e.touches[0].clientX;endY=e.touches[0].clientY});el.addEventListener("touchend",function(e){if(Date.now()-startTime>maxTime){return}if(Math.abs(endX-startX)>800||Math.abs(endY-startY)>800){return}callBack()})}let cur_provinceName;let provincePie;function set_provincePie_dom(id){provincePie=echarts.init(document.getElementById(id));provincePie.showLoading();provincePie.on("click",e=>{provincePieClick(e);event.stopPropagation()})}let option_provincePie="";function init_provincePie(provinceName){cur_provinceName=provinceName;set_option_provincePie(provinceName);provincePie.hideLoading();if(provinceName==="中国"){option_provincePie["series"][0]["data"]=province_dataset}else{let data=genCityData(provinceName);option_provincePie["series"][0]["data"]=data.cities_dataset}provincePie.setOption(option_provincePie)}function genCityData(provinceName){let cities_dataset=new Array();for(let provinceIndex=0;provinceIndex<global_json.length;provinceIndex++){if(global_json[provinceIndex]["provinceShortName"]===provinceName){for(let citiesIndex=0;citiesIndex<global_json[provinceIndex]["cities"].length;citiesIndex++){let confirmedLength=global_json[provinceIndex]["cities"][citiesIndex]["confirmedCount"].length-1;let cityName=global_json[provinceIndex]["cities"][citiesIndex]["cityName"];let confirmedCount=global_json[provinceIndex]["cities"][citiesIndex]["confirmedCount"][confirmedLength];cities_dataset.push({name:cityName,value:confirmedCount})}}}return{cities_dataset:cities_dataset}}function getProvinceConfirmedCount(provinceName){let provinceConfirmedCount=0;for(let index=0;index<province_dataset.length;index++){if(province_dataset[index]["name"]===provinceName){provinceConfirmedCount=province_dataset[index]["value"];break}}return{provinceConfirmedCount:provinceConfirmedCount}}function getChinaConfirmedConut(){let chinaConfirmedCount;let length=global_china_dataset[1].length-1;chinaConfirmedCount=global_china_dataset[1][length];return{count:chinaConfirmedCount}}function set_option_provincePie(provinceName){let confirmedCount;let data;if(provinceName==="中国"){data=getChinaConfirmedConut();confirmedCount=data.count}else{data=getProvinceConfirmedCount(provinceName);confirmedCount=data.provinceConfirmedCount}option_provincePie={title:{text:provinceName+" 疫情比例",left:"center",subtext:"确诊 "+confirmedCount+" 人",subtextStyle:{fontSize:16,color:"#444444"}},tooltip:{trigger:"item",position:["55%","30%"],formatter:"{b}：{c}（{d}%）"},toolbox:{show:true,orient:"vertical",left:"right",top:"bottom",itemSize:isMobile?20:15,feature:{saveAsImage:{type:"jpeg",pixelRatio:4}}},label:{formatter:"{b}: {d}%",fontSize:14},series:[{type:"pie",radius:"55%",hoverOffset:10,selectedOffset:15,selectedMode:"single",minShowLabelAngle:3,color:["red","#D9B63A","#2E2AA4","#9F2E61","#4D670C","#BF675F","#1F814A","#357F88","#673509","#310937","#1B9637","#F7393C"],radius:[0,"60%"],center:["50%","60%"],label:{alignTo:"edge",margin:"5%"},labelLine:{length:10,length2:1}}],graphic:{elements:[{type:"text",invisible:isMobile?false:true,right:"10%",bottom:"2%",slient:true,style:{text:"点击图中『元素』或『空白』联动下图",font:isMobile?'12px "cursive", sans-serif':'14px "cursive", sans-serif',fill:"#8888FF"}}]}}}function provincePieClick(params){let city_name=params.data.name;if(cur_provinceName=="中国"){init_populationChart(city_name,city_name)}else{init_populationChart(cur_provinceName,city_name)}}if(isMobile){tap(provincePie_bg,function(e){init_provincePie(cur_provinceName);init_populationChart(cur_provinceName,cur_provinceName)})}else{provincePie_bg.addEventListener("click",function(e){if(e){init_provincePie(cur_provinceName);init_populationChart(cur_provinceName,cur_provinceName)}},false)}let populationChart;function set_populationChart_dom(id){populationChart=echarts.init(document.getElementById(id));populationChart.showLoading()}let population_dataset;let option_populationChart;function init_populationChart(province_name,city_name){set_option_populationChart(city_name);if(province_name===city_name){if(province_name==="中国"){$.when(read_global_json).done(function(){population_dataset=global_china_dataset;option_populationChart["dataset"]["source"]=population_dataset;option_populationChart["legend"]["selected"]={确诊:true,疑似:true,治愈:true,死亡:true}})}else{for(let provinceIndex=0;provinceIndex<global_json.length;provinceIndex++){if(global_json[provinceIndex]["provinceShortName"]===province_name){populationChart.showLoading();gen_population_dataset(global_json[provinceIndex]);option_populationChart["dataset"]["source"]=population_dataset;option_populationChart["legend"]["selected"]={确诊:true,疑似:false,治愈:true,死亡:true};break}}}}else{for(let provinceIndex=0;provinceIndex<global_json.length;provinceIndex++){if(global_json[provinceIndex]["provinceShortName"]===province_name){for(let cityIndex=0;cityIndex<global_json[provinceIndex]["cities"].length;cityIndex++){if(global_json[provinceIndex]["cities"][cityIndex]["cityName"]===city_name){gen_population_dataset(global_json[provinceIndex]["cities"][cityIndex]);option_populationChart["dataset"]["source"]=population_dataset;option_populationChart["legend"]["selected"]={确诊:true,疑似:false,治愈:true,死亡:true};break}}break}}}set_option_populationChart_markPoint();populationChart.hideLoading();populationChart.setOption(option_populationChart);init_populationRatioChart(city_name,population_dataset)}function gen_population_dataset(object_dict){population_dataset=new Array();population_dataset[0]=["状态"].concat(global_date_list);population_dataset[1]=["确诊"].concat(object_dict["confirmedCount"]);population_dataset[2]=["疑似"].concat(object_dict["suspectedCount"]);population_dataset[3]=["治愈"].concat(object_dict["curedCount"]);population_dataset[4]=["死亡"].concat(object_dict["deadCount"])}function set_option_populationChart_markPoint(){for(let index=0;index<option_populationChart["series"].length;index++){option_populationChart["series"][index]["markPoint"]={symbol:isMobile?"circle":"circle",symbolSize:1,symbolOffset:[0,-10],data:[{value:option_populationChart["dataset"]["source"][1+index][option_populationChart["dataset"]["source"][1+index].length-1],xAxis:option_populationChart["dataset"]["source"][0][option_populationChart["dataset"]["source"][0].length-1],yAxis:option_populationChart["dataset"]["source"][1+index][option_populationChart["dataset"]["source"][1+index].length-1]}]}}}function set_option_populationChart(city_name){option_populationChart={title:{text:isMobile?city_name+" 疫情趋势图":city_name+" 疫情趋势图",left:isMobile?"center":"center"},legend:{show:true,bottom:isMobile?"80%":10,right:isMobile?"center":"center",width:isMobile?"90%":"auto",textStyle:{fontSize:isMobile?12:15}},tooltip:{trigger:"axis",showContent:true},toolbox:{show:true,orient:"vertical",left:"right",top:isMobile?"top":"bottom",itemSize:isMobile?20:15,feature:{saveAsImage:{type:"jpeg",pixelRatio:4}}},dataset:{source:[]},xAxis:{type:"category",boundaryGap:false,nameTextStyle:{fontSize:16},axisLabel:{fontSize:14},axisTick:{alignWithLabel:true,inside:false,length:8}},yAxis:{min:0,nameTextStyle:{fontSize:16},axisLabel:{show:isMobile?false:true,fontSize:15},axisTick:{show:isMobile?false:true},axisLine:{show:isMobile?false:true}},grid:{left:isMobile?20:"10%",right:isMobile?20:"5%",bottom:isMobile?35:60},series:[{type:"line",smooth:false,seriesLayoutBy:"row",symbolSize:8,symbol:"circle",zlevel:2,z:4,itemStyle:{normal:{color:"red",borderColor:"white",borderWidth:isMobile?1:2}},lineStyle:{width:3}},{type:"line",smooth:false,seriesLayoutBy:"row",symbolSize:8,symbol:"circle",zlevel:2,z:3,itemStyle:{normal:{color:"#cc0099",borderColor:"white",borderWidth:isMobile?1:2}}},{type:"line",smooth:false,seriesLayoutBy:"row",symbolSize:8,symbol:"circle",zlevel:2,z:2,itemStyle:{normal:{color:"green",borderColor:"white",borderWidth:isMobile?1:2}}},{type:"line",smooth:false,seriesLayoutBy:"row",symbolSize:8,symbol:"circle",zlevel:2,z:1,itemStyle:{normal:{color:"black",borderColor:"white",borderWidth:isMobile?1:2}}}]}}let populationRatioChart;let option_populationRatioChart="";function set_populationRatioChart_dom(id){populationRatioChart=echarts.init(document.getElementById(id));populationRatioChart.showLoading()}let populationRatio_dataset;function init_populationRatioChart(province_name,population_tmp_dataset){set_option_populationRatioChart(province_name);genRatio(population_tmp_dataset);option_populationRatioChart["dataset"]["source"]=populationRatio_dataset;if(province_name=="中国"){option_populationRatioChart["legend"]["selected"]={确诊:true,疑似:true,治愈:true,死亡:true}}else{option_populationRatioChart["legend"]["selected"]={确诊:true,疑似:false,治愈:true,死亡:true}}populationRatioChart.hideLoading();populationRatioChart.setOption(option_populationRatioChart)}function genRatio(population_tmp_dataset){populationRatio_dataset=JSON.parse(JSON.stringify(population_tmp_dataset));for(let row=1;row<population_tmp_dataset.length;row++){for(let col=2;col<population_tmp_dataset[0].length;col++){if(population_tmp_dataset[row][col-1]==0){populationRatio_dataset[row][col]=0}else{populationRatio_dataset[row][col]=Math.floor(((population_tmp_dataset[row][col]-population_tmp_dataset[row][col-1])/population_tmp_dataset[row][col-1])*1000)/1000}}}for(let row=0;row<populationRatio_dataset.length;row++){populationRatio_dataset[row].splice(1,1)}}function set_option_populationRatioChart(city_name){option_populationRatioChart={title:{text:isMobile?city_name+" 疫情环比图":city_name+" 疫情环比图",left:isMobile?"center":"center"},legend:{show:true,bottom:isMobile?"80%":10,right:isMobile?"center":"center",width:isMobile?"90%":"auto",textStyle:{fontSize:isMobile?12:15}},tooltip:{trigger:"axis",showContent:true,},toolbox:{show:true,orient:"vertical",left:"right",top:isMobile?"top":"bottom",itemSize:isMobile?20:15,feature:{saveAsImage:{type:"jpeg",pixelRatio:4}}},dataset:{source:[]},xAxis:{type:"category",boundaryGap:false,nameTextStyle:{fontSize:16},axisLabel:{fontSize:14},axisTick:{alignWithLabel:true,inside:false,length:8}},yAxis:{nameTextStyle:{fontSize:16},axisLabel:{show:isMobile?false:true,fontSize:15},axisTick:{show:isMobile?false:true},axisLine:{show:isMobile?false:true}},grid:{left:isMobile?20:"10%",right:isMobile?20:"5%",bottom:isMobile?35:60},series:[{type:"line",smooth:true,seriesLayoutBy:"row",symbolSize:6,symbol:"circle",zlevel:2,z:4,itemStyle:{normal:{color:"red",borderColor:"white",borderWidth:isMobile?1:2}},lineStyle:{width:2}},{type:"line",smooth:true,seriesLayoutBy:"row",symbolSize:6,symbol:"circle",zlevel:2,z:3,itemStyle:{normal:{color:"#cc0099",borderColor:"white",borderWidth:isMobile?1:2}}},{type:"line",smooth:true,seriesLayoutBy:"row",symbolSize:6,symbol:"circle",zlevel:2,z:2,itemStyle:{normal:{color:"green",borderColor:"white",borderWidth:isMobile?1:2}}},{type:"line",smooth:true,seriesLayoutBy:"row",symbolSize:6,symbol:"circle",zlevel:2,z:1,itemStyle:{normal:{color:"black",borderColor:"white",borderWidth:isMobile?1:2}}}]}}